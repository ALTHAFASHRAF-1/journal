// Updated admin.html script section - replace the existing script
<script>
    // Configuration - Replace with your Google Script URL
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyZys7T-JbfU9Htj6TdF5qoB6sF5FoFWJ_kXS-4eTXjPXsRN8DS0iivvr_9QWPYPB3QVg/exec';
    
    let currentDataView = 'issues';
    let isLoading = false;
    
    // Tab Management
    function initTabs() {
        const tabs = {
            'addIssueTab': 'addIssuePanel',
            'addArticleTab': 'addArticlePanel',
            'addFullArticleTab': 'addFullArticlePanel',
            'viewDataTab': 'viewDataPanel'
        };
        
        Object.keys(tabs).forEach(tabId => {
            document.getElementById(tabId).addEventListener('click', () => {
                if (isLoading) return;
                
                // Reset all tabs
                Object.keys(tabs).forEach(id => {
                    const tab = document.getElementById(id);
                    const panel = document.getElementById(tabs[id]);
                    tab.classList.remove('active');
                    panel.classList.add('hidden');
                });
                
                // Activate clicked tab
                document.getElementById(tabId).classList.add('active');
                document.getElementById(tabs[tabId]).classList.remove('hidden');
                
                if (tabId === 'addArticleTab' || tabId === 'addFullArticleTab') {
                    loadIssueOptions();
                } else if (tabId === 'viewDataTab') {
                    currentDataView = 'issues';
                    loadCurrentData();
                }
            });
        });
    }

    // Load issue options with better error handling
    async function loadIssueOptions() {
        const selects = ['articleIssueId', 'fullArticleIssueId'];
        
        selects.forEach(selectId => {
            const select = document.getElementById(selectId);
            if (select) {
                select.innerHTML = '<option value="">Loading issues...</option>';
            }
        });
        
        try {
            const url = `${GOOGLE_SCRIPT_URL}?action=getIssues&_=${Date.now()}`;
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                },
                cache: 'no-cache'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (data.success) {
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        select.innerHTML = '<option value="">Select an issue...</option>';
                        
                        const issueEntries = Object.entries(data.data || {});
                        if (issueEntries.length === 0) {
                            select.innerHTML = '<option value="">No issues available - Create an issue first</option>';
                            return;
                        }
                        
                        issueEntries.forEach(([issueId, issue]) => {
                            const option = document.createElement('option');
                            option.value = issueId;
                            option.textContent = `${issue.title} (Vol. ${issue.volume}, No. ${issue.number})`;
                            option.dataset.volume = issue.volume;
                            option.dataset.number = issue.number;
                            option.dataset.year = issue.year;
                            option.dataset.issueTitle = issue.title;
                            option.dataset.publishedDate = issue.publishedDate;
                            option.dataset.coverImage = issue.coverImage;
                            select.appendChild(option);
                        });
                    }
                });
                
                showMessage('Issues loaded successfully!', 'success');
            } else {
                throw new Error(data.data || 'Unknown error');
            }
        } catch (error) {
            console.error('Error loading issues:', error);
            showMessage('Error loading issues: ' + error.message, 'error');
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">Error loading issues - Please refresh</option>';
                }
            });
        }
    }

    // Enhanced form submission for issues
    document.getElementById('addIssueForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (isLoading) return;
        isLoading = true;
        
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<div class="loading-spinner mr-2"></div>Creating Issue...';
        submitBtn.disabled = true;
        
        const formData = {
            action: 'addIssue',
            issueId: document.getElementById('issueId').value.trim(),
            volume: parseInt(document.getElementById('volume').value),
            number: parseInt(document.getElementById('number').value),
            year: parseInt(document.getElementById('year').value),
            title: document.getElementById('issueTitle').value.trim(),
            publishedDate: document.getElementById('publishedDate').value,
            coverImage: document.getElementById('coverImage').value.trim()
        };
        
        // Enhanced validation
        if (!formData.issueId || !formData.title || !formData.publishedDate || !formData.coverImage) {
            showMessage('Please fill in all required fields', 'error');
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            isLoading = false;
            return;
        }
        
        if (isNaN(formData.volume) || isNaN(formData.number) || isNaN(formData.year)) {
            showMessage('Volume, Number, and Year must be valid numbers', 'error');
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            isLoading = false;
            return;
        }
        
        try {
            const response = await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData),
                cache: 'no-cache'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                showMessage('Issue created successfully!', 'success');
                document.getElementById('addIssueForm').reset();
                setDefaultDates(); // Reset dates
            } else {
                showMessage('Error: ' + result.data, 'error');
            }
        } catch (error) {
            console.error('Error creating issue:', error);
            showMessage('Error creating issue: ' + error.message, 'error');
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            isLoading = false;
        }
    });

    // Load and display current data with better error handling
    async function loadCurrentData() {
        const dataDisplay = document.getElementById('dataDisplay');
        dataDisplay.innerHTML = `
            <div class="flex items-center justify-center py-8">
                <div class="loading-spinner mr-3"></div>
                <p class="text-gray-500">Loading ${currentDataView}...</p>
            </div>
        `;
        
        try {
            const action = currentDataView === 'issues' ? 'getIssues' : 'getArticles';
            const url = `${GOOGLE_SCRIPT_URL}?action=${action}&_=${Date.now()}`;
            
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                },
                cache: 'no-cache'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (data.success) {
                displayData(data.data || {});
            } else {
                throw new Error(data.data || 'Unknown error');
            }
        } catch (error) {
            console.error('Error loading data:', error);
            dataDisplay.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
                    <p class="text-red-500 font-medium">Error loading ${currentDataView}</p>
                    <p class="text-gray-600 mb-4">${error.message}</p>
                    <button onclick="loadCurrentData()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-sync-alt mr-2"></i>Retry
                    </button>
                </div>
            `;
        }
    }

    // Rest of your existing functions remain the same...
    // (displayData, displayIssuesData, displayArticlesData, showMessage, etc.)

    // Initialize with better error handling
    document.addEventListener('DOMContentLoaded', () => {
        try {
            initTabs();
            setDefaultDates();
            
            // Test connection on load
            fetch(`${GOOGLE_SCRIPT_URL}?action=getIssues&_=${Date.now()}`, {
                method: 'GET',
                cache: 'no-cache'
            })
            .then(response => {
                if (response.ok) {
                    showMessage('Connected to Google Sheets successfully!', 'success');
                } else {
                    showMessage('Warning: Connection to Google Sheets may have issues', 'warning');
                }
            })
            .catch(error => {
                showMessage('Warning: Could not connect to Google Sheets. Check the URL.', 'warning');
                console.error('Connection test failed:', error);
            });
            
        } catch (error) {
            console.error('Initialization error:', error);
            showMessage('Error initializing admin panel', 'error');
        }
    });
</script>
